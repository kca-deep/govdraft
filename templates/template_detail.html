<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>템플릿 상세 정보</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 아이콘 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        
        /* 콘텐츠 영역 스타일 */
        .content-area {
            white-space: pre-wrap !important;
            word-break: break-word;
            overflow-wrap: break-word;
            line-height: 1.8;
        }
        
        .content-area p {
            margin-bottom: 16px;
            white-space: pre-wrap !important;
        }
        
        .content-area br {
            display: block;
            content: "";
            margin-top: 8px;
        }

        /* 구조적 텍스트 포맷 스타일 */
        .content-area p {
            margin-bottom: 20px;
        }
        .content-area .main-item {
            font-weight: 500;
            margin-top: 10px;
            margin-bottom: 5px;
            display: block;
        }
        .content-area .sub-item {
            margin-left: 20px;
            display: block;
            margin-bottom: 3px;
        }
        .content-area .comment-item {
            margin-left: 30px;
            display: block;
            font-size: 0.9em;
            color: #555;
            font-style: italic;
            margin-bottom: 3px;
        }
        
        /* 테이블 스타일 */
        .content-area table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 1rem;
        }
        .content-area th, .content-area td {
            border: 1px solid #e2e8f0;
            padding: 0.5rem;
            text-align: left;
        }
        .content-area th {
            background-color: #f1f5f9;
            font-weight: 500;
        }
        .content-area tr:nth-child(even) {
            background-color: #f8fafc;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="p-6">
                <!-- 로딩 표시기 -->
                <div id="loading" class="flex items-center justify-center my-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
                    <span class="ml-3 text-lg text-gray-600">템플릿 정보를 불러오는 중...</span>
                </div>
                
                <!-- 템플릿 정보 -->
                <div id="template-content" class="hidden">
                    <header class="mb-6 flex justify-between items-start">
                        <div>
                            <h1 id="template-title" class="text-3xl font-bold text-gray-800 mb-2"></h1>
                            <div class="flex items-center text-gray-600">
                                <span id="template-ministry" class="mr-4"></span>
                                <span id="template-date"></span>
                            </div>
                        </div>
                        <a href="/" class="text-blue-600 hover:text-blue-800 flex items-center">
                            <i class="fas fa-arrow-left mr-2"></i> 목록으로 돌아가기
                        </a>
                    </header>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div class="md:col-span-2">
                            <div class="mb-8">
                                <h2 class="text-xl font-semibold text-gray-800 mb-3">개요</h2>
                                <div id="template-summary" class="text-gray-600 leading-relaxed content-area"></div>
                            </div>
                            
                            <div class="mb-8">
                                <h2 class="text-xl font-semibold text-gray-800 mb-3">주요 내용</h2>
                                <div id="template-content-main" class="prose max-w-none content-area"></div>
                            </div>
                            
                            <!-- 템플릿 미리보기 -->
                            <div class="mb-8">
                                <h2 class="text-xl font-semibold text-gray-800 mb-3">문서 미리보기</h2>
                                <div class="border border-gray-200 rounded-lg p-6">
                                    <div id="template-preview" class="prose max-w-none content-area"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="md:col-span-1">
                            <div class="bg-gray-50 rounded-lg p-5 mb-6">
                                <h2 class="text-lg font-medium text-gray-800 mb-4">메타데이터</h2>
                                
                                <div class="mb-3">
                                    <h3 class="text-sm font-medium text-gray-700">발행 부처</h3>
                                    <p id="meta-ministry" class="text-gray-600"></p>
                                </div>
                                
                                <div class="mb-3">
                                    <h3 class="text-sm font-medium text-gray-700">문서 유형</h3>
                                    <p id="meta-doctype" class="text-gray-600"></p>
                                </div>
                                
                                <div class="mb-3">
                                    <h3 class="text-sm font-medium text-gray-700">발행일</h3>
                                    <p id="meta-date" class="text-gray-600"></p>
                                </div>
                                
                                <div class="mb-3">
                                    <h3 class="text-sm font-medium text-gray-700">작성자</h3>
                                    <p id="meta-author" class="text-gray-600"></p>
                                </div>
                                
                                <div class="mb-3">
                                    <h3 class="text-sm font-medium text-gray-700">태그</h3>
                                    <div id="meta-tags" class="flex flex-wrap gap-2 mt-1"></div>
                                </div>
                            </div>
                            
                            <div class="rounded-lg border border-blue-200 bg-blue-50 p-5">
                                <h2 class="text-lg font-medium text-blue-800 mb-4">템플릿 설정</h2>
                                
                                <div class="space-y-4">
                                    <button id="use-template" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition duration-300 ease-in-out">
                                        이 템플릿 사용하기
                                    </button>
                                    
                                    <button id="download-template" class="w-full bg-white border border-blue-600 hover:bg-blue-50 text-blue-600 font-medium py-2 px-4 rounded-lg transition duration-300 ease-in-out">
                                        템플릿 다운로드
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 에러 메시지 -->
                <div id="error-message" class="hidden flex flex-col items-center justify-center py-16 text-center">
                    <i class="fas fa-exclamation-circle text-red-500 text-5xl mb-4"></i>
                    <h3 class="text-xl font-medium text-gray-600 mb-2">템플릿을 찾을 수 없습니다</h3>
                    <p class="text-gray-500">요청하신 템플릿 정보를 찾지 못했습니다.</p>
                    <a href="/" class="mt-4 text-blue-600 hover:text-blue-800">목록으로 돌아가기</a>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const templateId = '{{ template_id }}';
            const loading = document.getElementById('loading');
            const templateContent = document.getElementById('template-content');
            const errorMessage = document.getElementById('error-message');
            
            // 사용 버튼 이벤트 리스너
            document.getElementById('use-template').addEventListener('click', function() {
                alert('이 템플릿이 선택되었습니다.');
                // 여기에 템플릿 사용 로직 추가
            });
            
            // 다운로드 버튼 이벤트 리스너
            document.getElementById('download-template').addEventListener('click', function() {
                alert('템플릿 다운로드를 시작합니다.');
                // 여기에 다운로드 로직 추가
            });
            
            // 템플릿 정보 가져오기
            fetchTemplateDetails(templateId);
            
            // 템플릿 상세 정보 가져오기 함수
            async function fetchTemplateDetails(templateId) {
                try {
                    loading.classList.remove('hidden');
                    errorMessage.classList.add('hidden');
                    templateContent.classList.add('hidden');
                    
                    // API에서 템플릿 상세 정보 가져오기
                    const response = await fetch(`/api/templates/${templateId}`);
                    
                    if (!response.ok) {
                        throw new Error('템플릿 정보를 가져오는데 실패했습니다.');
                    }
                    
                    const templateData = await response.json();
                    
                    // API 응답 데이터를 콘솔에 출력
                    console.log('API 응답 데이터:');
                    console.log(JSON.stringify(templateData, null, 2));
                    
                    loading.classList.add('hidden');
                    templateContent.classList.remove('hidden');
                    
                    // 성공적으로 데이터를 가져왔다면 화면에 표시
                    displayTemplateDetails(templateData);
                } catch (error) {
                    console.error('템플릿 정보를 가져오는데 실패했습니다:', error);
                    loading.classList.add('hidden');
                    errorMessage.classList.remove('hidden');
                }
            }
            
            // 템플릿 상세 정보 표시 함수
            function displayTemplateDetails(template) {
                if (!template) {
                    loading.classList.add('hidden');
                    errorMessage.classList.remove('hidden');
                    return;
                }
                
                // 콘솔에 템플릿 데이터를 JSON 형태로 출력
                console.log('템플릿 상세 정보:');
                console.log(JSON.stringify(template, null, 2));
                
                // 기본 정보 표시
                document.getElementById('template-title').textContent = template.title;
                document.getElementById('template-ministry').textContent = template.ministry || '미지정';
                document.getElementById('template-doc-type').textContent = template.docType || '미지정';
                document.getElementById('template-author').textContent = template.author || '미지정';
                document.getElementById('template-date').textContent = new Date(template.publishedDate).toLocaleDateString('ko-KR');
                
                // 줄바꿈 처리를 위해 summary는 특별히 처리
                document.getElementById('template-summary').innerHTML = 
                    (template.summary || '').replace(/\n/g, '<br>');
                
                // 내용과 미리보기는 formatContent 함수 사용
                document.getElementById('template-content-main').innerHTML = formatContent(template.content);
                document.getElementById('template-preview').innerHTML = formatContent(template.preview);
                
                // 메타데이터 표시
                document.getElementById('meta-ministry').textContent = template.ministry;
                document.getElementById('meta-doctype').textContent = template.docType;
                document.getElementById('meta-date').textContent = new Date(template.publishedDate).toLocaleDateString('ko-KR');
                document.getElementById('meta-author').textContent = template.author;
                
                // 태그 표시
                const tagsContainer = document.getElementById('meta-tags');
                tagsContainer.innerHTML = '';
                
                if (template.tags && template.tags.length > 0) {
                    template.tags.forEach(tag => {
                        const tagElement = document.createElement('span');
                        tagElement.className = 'px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full';
                        tagElement.textContent = tag;
                        tagsContainer.appendChild(tagElement);
                    });
                } else {
                    tagsContainer.textContent = '태그 정보 없음';
                }
                
                // 로딩 상태 숨기고 콘텐츠 표시
                loading.classList.add('hidden');
                templateContent.classList.remove('hidden');
            }
            
            // 내용의 줄바꿈과 포맷을 처리하는 함수
            function formatContent(content) {
                if (!content) return '';
                
                // HTML 문자열로 구성된 경우
                if (/<[a-z][\s\S]*>/i.test(content)) {
                    // 임시 DOM 엘리먼트를 생성하여 콘텐츠를 파싱
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = content;
                    
                    // 구조적 텍스트 포맷 적용
                    return applyStructuredFormat(tempDiv.innerText);
                } else {
                    // 일반 텍스트에 구조적 포맷 적용
                    return applyStructuredFormat(content);
                }
            }
            
            // 텍스트를 구조적으로 포맷팅하는 함수
            function applyStructuredFormat(text) {
                if (!text) return '';
                
                // 두 개 이상의 연속된 줄바꿈으로 단락 구분
                const paragraphs = text.split(/\n\s*\n/);
                let formattedContent = '';
                
                paragraphs.forEach(paragraph => {
                    if (paragraph.trim() === '') {
                        formattedContent += '<p><br></p>';
                        return;
                    }
                    
                    // 각 줄을 배열로 분리
                    const lines = paragraph.split('\n');
                    let formattedParagraph = '<p>';
                    
                    lines.forEach(line => {
                        let trimmedLine = line.trim(); // const를 let으로 변경하여 수정 가능하게 함

                        // 문제의 주석 문자열 명시적 제거
                        trimmedLine = trimmedLine.replace(/\{\s*\/\*\s*prose 제거,\s*text-card-foreground 추가\s*\*\/\s*\}/g, '').trim();

                        // 주석 제거 후 빈 줄이면 건너뛰기
                        if (trimmedLine === '') return;

                        // 주요 항목 (네모 기호로 시작)
                        if (/^-\s/.test(trimmedLine) || /^•\s/.test(trimmedLine) || /^[\d]+[\.\)]\s/.test(trimmedLine)) {
                            formattedParagraph += `<span class="main-item">□ ${trimmedLine.replace(/^-\s|^•\s|^[\d]+[\.\)]\s/, '')}</span>`;
                        }
                        // 하위 항목 (동그라미 기호로 시작, 들여쓰기 적용)
                        else if (/^\s+-\s/.test(line) || /^\s+•\s/.test(line) || /^\s+[\d]+[\.\)]\s/.test(line)) {
                            formattedParagraph += `<span class="sub-item">○ ${line.replace(/^\s+-\s|^\s+•\s|^\s+[\d]+[\.\)]\s/, '')}</span>`;
                        }
                        // 주석이나 참고사항 (별표로 시작, 추가 들여쓰기)
                        else if (trimmedLine.startsWith('*') || trimmedLine.startsWith('※')) {
                            formattedParagraph += `<span class="comment-item">* ${trimmedLine.substring(1)}</span>`;
                        }
                        // 기본 텍스트 라인
                        else {
                            // 단락의 첫 줄이 아니거나 이전 라인이 있으면 줄바꿈 추가
                            if (formattedParagraph !== '<p>') {
                                formattedParagraph += '<br>';
                            }
                            formattedParagraph += trimmedLine;
                        }
                    });
                    
                    formattedParagraph += '</p>';
                    formattedContent += formattedParagraph;
                });
                
                // 기존의 줄바꿈 스타일을 유지하는 추가 처리
                formattedContent = formattedContent.replace(/<span class="(main-item|sub-item|comment-item)">/g, '<br><span class="$1">');
                
                return formattedContent;
            }
        });
    </script>
</body>
</html>